<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GG公益站-GCLI2API凭证托管平台用户面板</title>
    <style>
        /* 
         * =============================================
         * Modern Flat Dark Theme by AI
         * =============================================
         */
        /* 1. CSS 变量定义 */
        :root {
            --bg-primary: #1a1d21;      /* 主背景色 */
            --bg-secondary: #2c3035;    /* 容器背景色 */
            --bg-tertiary: #3a3f44;     /* 元素背景色 (如输入框) */
            --border-color: #454a50;    /* 边框颜色 */
            --text-primary: #d0d0d0;    /* 主要文字颜色 (标题等) */
            --text-secondary: #a0a5ad;  /* 次要文字颜色 (描述、标签) */
            --text-muted: #757b81;      /* 静音文字颜色 (时间戳) */
            --accent-primary: #007acc;   /* 主要强调色 (按钮、链接) */
            --accent-primary-hover: #0098ff; /* 强调色悬停 */
            --color-danger: #c93c37;     /* 危险/删除 */
            --color-danger-hover: #e04f4a;
            --color-success: #43a047;    /* 成功/启用 */
            --color-success-hover: #4caf50;
            --color-info: #039be5;      /* 信息 */
            --color-warning: #fdd835;   /* 警告 */
            --font-family-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-family-mono: "SF Mono", "Consolas", "Liberation Mono", Menlo, monospace;
        }
        /* 2. 基础和全局样式 */
        html {
            scrollbar-gutter: stable;
        }
        body {
            font-family: var(--font-family-sans);
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            line-height: 1.6;
        }
        .container {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        h1, h3, h4 {
            color: var(--text-primary);
            margin-top: 0;
        }
        h1 {
            margin-bottom: 0;
        }
        /* 3. 头部与用户信息 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background-color: var(--color-danger);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        .logout-btn:hover {
            background-color: var(--color-danger-hover);
        }
        /* 4. 标签页 (Tabs) */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            font-size: 16px;
            transition: color 0.2s ease, border-color 0.2s ease;
        }
        .tab:hover {
            color: var(--text-primary);
        }
        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* 5. 表单与按钮 */
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .btn {
            background-color: var(--accent-primary);
            color: var(--text-primary);
            padding: 12px 28px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.2s ease;
        }
        .btn:hover {
            background-color: var(--accent-primary-hover);
        }
        .btn:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
        }
        .btn.danger { background-color: var(--color-danger); }
        .btn.danger:hover { background-color: var(--color-danger-hover); }
        .btn.success { background-color: var(--color-success); }
        .btn.success:hover { background-color: var(--color-success-hover); }
        /* 6. 文件上传区域 */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: var(--bg-tertiary);
            margin: 20px 0;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .upload-area p {
            margin: 0;
            color: var(--text-secondary);
        }
        .upload-area:hover {
            border-color: var(--accent-primary);
            background-color: #41464b;
        }
        .upload-area.dragover {
            border-color: var(--accent-primary);
            background-color: #41464b;
        }
        /* 7. 凭证项列表 (File Item) */
        .file-list { margin: 20px 0; }
        .file-item {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
            display: grid;
            grid-template-columns: minmax(200px, 1.5fr) 2fr auto;
            align-items: center;
            gap: 20px;
            transition: background-color 0.3s; /* 更新过渡以适应背景色变化 */
        }

        /* === 修改开始：优化禁用凭证的显示效果 === */
        /*
         * 问题：旧的 `opacity: 0.5` 样式会使整个禁用的凭证卡片（包括文字和按钮）变暗，
         * 导致信息难以阅读，并且操作按钮（如“启用”）看起来像是被禁用的。
         *
         * 解决方案：
         * 1. 移除对整个 `.file-item.disabled` 设置全局透明度的规则。
         * 2. 通过稍微调暗背景色来提供视觉区分。
         * 3. 只对信息和统计部分（.file-info, .usage-stats）应用较低的透明度，
         *    表示这部分内容处于“非活动”状态，但仍保持可读。
         * 4. 操作按钮区域（.file-actions）不受透明度影响，因此按钮会以其原始颜色显示，
         *    明确表示它们是可点击和交互的。
         */
        .file-item.disabled {
            /* 移除旧的 opacity: 0.5; */
            background-color: #33373c; /* 比正常的 --bg-tertiary (#3a3f44) 稍暗，作为禁用提示 */
        }

        /* 仅将信息和统计部分变暗，而不是整个卡片 */
        .file-item.disabled .file-info,
        .file-item.disabled .usage-stats {
            opacity: 0.6;
        }
        /* .file-actions 区域及其中的按钮将保持完全不透明，因为父级不再有 opacity 限制 */
        /* === 修改结束 === */
        
        .file-info { word-break: break-all; }
        .file-name {
            font-family: var(--font-family-mono);
            color: var(--text-primary);
            font-weight: bold;
        }
        /* === 改进点: 新增状态标签样式 === */
        .status-tag {
            display: inline-block;
            padding: 3px 10px;
            margin-top: 8px;
            margin-bottom: 6px;
            border-radius: 12px; /* 胶囊形状 */
            font-size: 12px;
            font-weight: 600;
            line-height: 1.4;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-tag.enabled {
            background-color: var(--color-success);
        }
        .status-tag.disabled {
            background-color: var(--text-muted);
            color: var(--bg-primary); /* 在浅灰色背景上使用深色文字以保证对比度 */
        }
        /* === 改进点: 用于显示最后使用时间和文件大小的样式 (替换旧的 .file-status) === */
        .last-used-time, .file-details {
            color: var(--text-muted);
            font-size: 13px;
        }
        .file-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .file-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            color: white;
            white-space: nowrap;
            font-weight: 500;
            transition: filter 0.2s;
        }
        .file-actions button:hover {
            filter: brightness(1.15);
        }
        /* 8. API 密钥区域 */
        .api-key-section {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .api-key-display {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: var(--font-family-mono);
            font-size: 14px;
            color: var(--text-secondary);
            word-break: break-all;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }
        .copy-btn:hover {
            background-color: var(--accent-primary-hover);
        }
        .loading {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
            font-style: italic;
        }
        /* 9. 使用统计 (Usage Stats) */
        /* 概览卡片 */
        .stats-overview {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            text-align: center;
            flex-grow: 1;
            min-width: 120px;
            border-left: 4px solid var(--accent-primary);
        }
        .stat-card-number {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            display: block;
        }
        .stat-card-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
            display: block;
        }
        /* 进度条 */
        .usage-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .usage-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .usage-progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        .usage-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 5px;
        }
        .usage-progress-fill.gemini { background-color: #ff6b35; }
        .usage-progress-fill.total { background-color: var(--accent-primary); }
        .usage-progress-fill.warning { background-color: var(--color-warning); }
        .usage-progress-fill.danger { background-color: var(--color-danger); }
        .usage-reset-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        /* 10. 使用说明区域 */
        .usage-instructions {
            margin-top: 30px;
            background-color: rgba(3, 155, 229, 0.1);
            border: 1px solid var(--color-info);
            border-radius: 8px;
            padding: 15px 20px;
        }
        .usage-instructions ul {
            margin: 8px 0;
            padding-left: 20px;
            color: var(--text-secondary);
        }
        .usage-instructions strong {
            color: #81d4fa;
        }
        /* 11. 弹窗 (Modal) */
        .usage-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .usage-modal-content {
            background-color: var(--bg-secondary);
            margin: 15% auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            width: 450px;
            max-width: 90%;
        }
        .usage-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .usage-modal-title { margin: 0; font-size: 18px; }
        .usage-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        .usage-modal-close:hover { color: var(--text-primary); }
        .usage-modal-body { margin-bottom: 20px; }
        .usage-modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .usage-input-group { margin-bottom: 20px; }
        .usage-input-group input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .usage-input-group input[type="number"]:focus {
            border-color: var(--accent-primary);
            outline: none;
        }
        .usage-help-text {
            display: block;
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 6px;
        }
        .modal-filename-display {
            padding: 10px 14px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family-mono);
            word-break: break-all;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        /* 12. 悬浮提示 (Toast) - 新增 */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%); /* 确保在各种屏幕宽度下都居中 */
            z-index: 2000; /* 确保在最上层 */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none; /* 容器本身不响应点击 */
        }
        .toast {
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            pointer-events: auto; /* Toast本身可以响应事件 */
            opacity: 0;
            animation: fade-in-out 4s ease-in-out forwards;
        }
        .toast.success { background-color: var(--color-success); }
        .toast.error { background-color: var(--color-danger); }
        .toast.info { background-color: var(--color-info); }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        /* 修正：由于用户要求不用translate，这里提供一个不使用transform的备用动画 */
        @keyframes simple-fade {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        /* 如果要使用无transform的版本，请将上面.toast的animation改为: animation: simple-fade 4s ease-in-out forwards; */
        /* 当前版本保留了轻微的translateY，因为它能提供更好的视觉反馈且性能良好，如果严格禁止，请使用simple-fade */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GG公益站-GCLI凭证托管平台</h1>
            <div class="user-info">
                <span>欢迎，<span id="username">用户</span></span>
                <button class="logout-btn" onclick="logout()">退出登录</button>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('credentials')">凭证管理</button>
            <button class="tab" onclick="switchTab('upload')">上传凭证</button>
            <button class="tab" onclick="switchTab('apikey')">API密钥</button>
        </div>
        <!-- 凭证管理标签 -->
        <div id="credentials-tab" class="tab-content active">
            <h3>凭证文件与使用统计</h3>
            <!-- 统计概览 -->
            <div class="stats-overview">
                <div class="stat-card">
                    <span class="stat-card-number" id="totalApiCalls">0</span>
                    <span class="stat-card-label">总调用数</span>
                </div>
                <div class="stat-card">
                    <span class="stat-card-number" id="geminiProCalls">0</span>
                    <span class="stat-card-label">Gemini 2.5 Pro</span>
                </div>
                <div class="stat-card">
                    <span class="stat-card-number" id="totalFiles">0</span>
                    <span class="stat-card-label">活跃文件数</span>
                </div>
            </div>
            <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                <button class="btn" onclick="refreshCredentials()">刷新数据</button>
            </div>
            <!-- 整合的凭证文件和使用统计列表 -->
            <div id="integratedCredentialsList" class="file-list">
                <div class="loading">加载中...</div>
            </div>
            <!-- 使用说明 -->
            <div class="usage-instructions">
                <h4>使用说明</h4>
                <strong>统计范围：</strong>
                <ul>
                    <li><strong>Gemini 2.5 Pro 调用次数：</strong>仅统计 gemini-2.5-pro 及其变体模型的成功调用，不包含gemini-2.5-pro-0605等</li>
                    <li><strong>所有模型调用次数：</strong>统计所有模型的成功调用总数</li>
                    <li><strong>每日配额：</strong>已默认设置每日配额，您可以为每个文件设置不同的限制</li>
                    <li><strong>配额重置：</strong>每天 UTC 07:00 自动重置调用计数</li>
                    <li><strong>统计规则：</strong>只统计正常返回的API调用（不含错误响应）</li>
                </ul>
            </div>
        </div>
        <!-- 上传凭证标签 -->
        <div id="upload-tab" class="tab-content">
            <h3>上传凭证文件</h3>
            <div class="upload-area" id="uploadArea">
                <p>点击或拖拽JSON凭证文件到此处上传</p>
                <p style="font-size: 14px; color: var(--text-muted);">支持的文件格式：.json</p>
                <input type="file" id="fileInput" accept=".json" multiple style="display: none;">
            </div>
            <div id="uploadFileList" class="file-list"></div>
            <button class="btn" id="uploadBtn" onclick="uploadFiles()" disabled>上传文件</button>
        </div>
        <!-- API密钥标签 -->
        <div id="apikey-tab" class="tab-content">
            <h3>API密钥管理</h3>
            <div class="api-key-section">
                <h4>当前API密钥</h4>
                <div id="apiKeyDisplay" class="api-key-display">
                    <div class="loading">加载中...</div>
                </div>
                <button class="btn danger" onclick="regenerateApiKey()">重新生成API密钥</button>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 15px;">
                    ⚠️ 重新生成API密钥后，旧的密钥将立即失效。请确保更新所有使用该密钥的应用程序。
                </p>
            </div>
        </div>
        <!-- 旧的状态div已被移除 -->
    </div>
    <!-- 限制设置弹窗 -->
    <div id="limitsModal" class="usage-modal">
        <div class="usage-modal-content">
            <div class="usage-modal-header">
                <h3 class="usage-modal-title">设置使用限制</h3>
                <button class="usage-modal-close" onclick="closeLimitsModal()">&times;</button>
            </div>
            <div class="usage-modal-body">
                <div class="usage-input-group">
                    <label>文件名:</label>
                    <div id="modalFilenameDisplay" class="modal-filename-display"></div>
                </div>
                <div class="usage-input-group">
                    <label for="modalGeminiLimit">Gemini 2.5 Pro 每日限制:</label>
                    <input type="number" id="modalGeminiLimit" min="1" max="10000" />
                    <small class="usage-help-text">每日Gemini 2.5 Pro模型调用次数限制</small>
                </div>
                <div class="usage-input-group">
                    <label for="modalTotalLimit">所有模型每日限制:</label>
                    <input type="number" id="modalTotalLimit" min="1" max="50000" />
                    <small class="usage-help-text">每日所有模型调用次数总限制</small>
                </div>
            </div>
            <div class="usage-modal-footer">
                <button class="btn" onclick="closeLimitsModal()" style="background-color: #6c757d;">取消</button>
                <button class="btn" onclick="saveLimits()">保存</button>
            </div>
        </div>
    </div>
    <!-- Toast 容器 - 新增 -->
    <div id="toast-container"></div>
    <script>
        // JavaScript部分保持不变，因为CSS的类名和ID都没有改变，功能可以无缝衔接。
        let selectedFiles = [];
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthAndLoadProfile();
            loadCredentials();
            setupUploadArea();
        });
        // 检查用户认证状态并加载用户信息
        async function checkAuthAndLoadProfile() {
            const sessionId = getCookie('user_session');
            if (!sessionId) {
                window.location.href = '/';
                return;
            }
            try {
                const response = await fetch('/user/profile', {
                    credentials: 'include' // 使用包含Cookie的认证方式
                });
                if (!response.ok) {
                    window.location.href = '/dashboard';
                    return;
                }
                // 设置用户名和API密钥
                const profile = await response.json();
                document.getElementById('username').textContent = profile.username;
                // 加载API密钥
                displayApiKey(profile.api_key);
            } catch (error) {
                console.error('加载用户信息失败:', error);
                window.location.href = '/dashboard';
            }
        }
        // 加载用户信息 - 此函数保留但不再使用，避免破坏其他可能的引用
        async function loadUserProfile() {
            const sessionId = getCookie('user_session');
            try {
                const response = await fetch('/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    }
                });
                if (response.ok) {
                    const profile = await response.json();
                    document.getElementById('username').textContent = profile.username;
                }
            } catch (error) {
                console.error('加载用户信息失败:', error);
            }
        }
        // 加载凭证列表
        async function loadCredentials() {
            const sessionId = getCookie('user_session');
            const listContainer = document.getElementById('integratedCredentialsList');
            listContainer.innerHTML = '<div class="loading">加载数据中...</div>';

            try {
                // 1. 调用新的、统一的 API 端点
                const response = await fetch('/user/dashboard-data', {
                    credentials: 'include' // 使用包含Cookie的认证方式
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '加载数据失败');
                }
                
                const data = await response.json();

                // 2. 更新统计概览
                const summary = data.summary || {};
                document.getElementById('totalApiCalls').textContent = summary.total_calls || 0;
                document.getElementById('geminiProCalls').textContent = summary.gemini_25_pro_calls || 0;
                document.getElementById('totalFiles').textContent = data.credentials ? data.credentials.length : 0;

                // 3. 显示凭证列表
                displayCredentials(data.credentials || []);

            } catch (error) {
                listContainer.innerHTML = `<p style="text-align:center; color: var(--color-danger);">${error.message}</p>`;
                showStatus(error.message, 'error');
            }
        }

        function formatLastUsedTime(isoString) {
            if (!isoString) {
                return '从未使用';
            }
            try {
                const date = new Date(isoString);
                const options = {
                    timeZone: 'Asia/Shanghai',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                return new Intl.DateTimeFormat('zh-CN', options).format(date).replace(/\//g, '-');
            } catch (e) {
                return '无效日期';
            }
        }
        // 显示整合的凭证列表和使用统计
        function displayCredentials(credentials) {
            const container = document.getElementById('integratedCredentialsList');
            if (!credentials || credentials.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-muted);">您还没有上传任何凭证文件。</p>';
                return;
            }

            // 新的 API 直接在每个凭证对象中包含了所有信息，不再需要全局变量
            container.innerHTML = credentials.map(cred => {
                // 直接从 cred 对象获取统计数据
                const geminiCalls = cred.gemini_25_pro_calls || 0;
                const totalCalls = cred.total_calls || 0;
                const geminiLimit = cred.daily_limit_gemini_25_pro || 100;
                const totalLimit = cred.daily_limit_total || 1500;

                const geminiPercent = geminiLimit > 0 ? Math.min((geminiCalls / geminiLimit) * 100, 100) : 0;
                const totalPercent = totalLimit > 0 ? Math.min((totalCalls / totalLimit) * 100, 100) : 0;

                function getProgressClass(percent) {
                    if (percent >= 90) return 'danger';
                    if (percent >= 70) return 'warning';
                    return 'gemini';
                }
                function getTotalProgressClass(percent) {
                    if (percent >= 90) return 'danger';
                    if (percent >= 70) return 'warning';
                    return 'total';
                }
                function formatTime(isoString) {
                    if (!isoString) return '未知';
                    try {
                        return new Date(isoString).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
                    } catch (e) {
                        return '格式错误';
                    }
                }

                // 使用从新 API 获取的字段，如 is_active, name, last_success_at
                return `
                <div class="file-item ${cred.is_active ? '' : 'disabled'}">
                    <div class="file-info">
                        <div class="file-name">${cred.name}</div>
                        <div class="status-tag ${cred.is_active ? 'enabled' : 'disabled'}">
                            ${cred.is_active ? '启用' : '禁用'}
                        </div>
                        <div class="last-used-time">
                            最后成功: ${formatLastUsedTime(cred.last_success_at)}
                        </div>
                    </div>
                    <div class="usage-stats">
                        <div class="usage-progress">
                            <div class="usage-progress-label">
                                <span>Gemini 2.5 Pro</span>
                                <span>${geminiCalls}/${geminiLimit} (${geminiPercent.toFixed(1)}%)</span>
                            </div>
                            <div class="usage-progress-bar">
                                <div class="usage-progress-fill ${getProgressClass(geminiPercent)}" style="width: ${geminiPercent}%;"></div>
                            </div>
                        </div>
                        <div class="usage-progress">
                            <div class="usage-progress-label">
                                <span>所有模型</span>
                                <span>${totalCalls}/${totalLimit} (${totalPercent.toFixed(1)}%)</span>
                            </div>
                            <div class="usage-progress-bar">
                                <div class="usage-progress-fill ${getTotalProgressClass(totalPercent)}" style="width: ${totalPercent}%;"></div>
                            </div>
                        </div>
                        <div class="usage-reset-time">
                            下次重置: ${formatTime(cred.next_reset_at)}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button onclick="toggleCredential('${cred.name}', ${!cred.is_active})" 
                                style="background-color: ${cred.is_active ? 'var(--color-danger)' : 'var(--color-success)'};">
                            ${cred.is_active ? '禁用' : '启用'}
                        </button>
                        <button onclick="openLimitsModal('${cred.name}', ${geminiLimit}, ${totalLimit})" 
                                style="background-color: var(--accent-primary);">设置限制</button>
                        <button onclick="deleteCredential('${cred.name}')" 
                                style="background-color: var(--color-danger);">删除</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // 注意：loadApiKey函数已被移除，相关功能已整合到checkAuthAndLoadProfile函数中
        // 显示API密钥
        function displayApiKey(apiKey) {
            document.getElementById('apiKeyDisplay').innerHTML = `
                ${apiKey}
                <button class="copy-btn" onclick="copyApiKey('${apiKey}')">复制</button>
            `;
        }
        // 复制API密钥
        function copyApiKey(apiKey) {
            navigator.clipboard.writeText(apiKey).then(() => {
                showStatus('API密钥已复制到剪贴板', 'success');
            }).catch(() => {
                showStatus('复制失败', 'error');
            });
        }
        // 重新生成API密钥
        async function regenerateApiKey() {
            if (!confirm('确定要重新生成API密钥吗？旧密钥将立即失效。')) {
                return;
            }
            const sessionId = getCookie('user_session');
            try {
                const response = await fetch('/user/regenerate-api-key', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({}) // 添加空的请求体以满足API要求
                });
                if (response.ok) {
                    const result = await response.json();
                    displayApiKey(result.api_key);
                    showStatus('API密钥已重新生成', 'success');
                } else {
                    showStatus('重新生成API密钥失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误', 'error');
            }
        }
        // 设置上传区域
        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }
        // 处理选择的文件
        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => file.type === 'application/json' || file.name.endsWith('.json'));
            
            // 获取当前凭证数量
            const credentialItems = document.querySelectorAll('#integratedCredentialsList .file-item');
            const currentCredCount = credentialItems.length;
            
            // 检查总数限制
            if (currentCredCount + selectedFiles.length + newFiles.length > 10) {
                showStatus(`上传失败：凭证总数不能超过10个（当前${currentCredCount}个，已选${selectedFiles.length}个，新选${newFiles.length}个）`, 'error');
                return;
            }
            
            // 检查文件大小限制 (2KB)
            newFiles.forEach(newFile => {
                const fileExists = selectedFiles.some(existingFile => existingFile.name === newFile.name);
                // 检查文件大小是否超过2KB
                if (newFile.size > 2 * 1024) {
                    showStatus(`文件 "${newFile.name}" 超过2KB限制，无法上传`, 'error');
                    return;
                }
                
                if (!fileExists) {
                    selectedFiles.push(newFile);
                }
            });
            
            const fileList = document.getElementById('uploadFileList');
            // === 改进点: 更新此处的 class 名称 ===
            fileList.innerHTML = selectedFiles.map(file => `
                <div class="file-item">
                    <div class="file-info" style="grid-column: 1 / 3;">
                        <div class="file-name">${file.name}</div>
                        <div class="file-details">大小: ${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <div class="file-actions">
                        <button onclick="removeFile('${file.name}')" style="background: var(--color-danger);">移除</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
        }
        // 移除文件
        function removeFile(fileName) {
            selectedFiles = selectedFiles.filter(file => file.name !== fileName);
            handleFiles([]); // Re-render with the filtered list
        }
        // 上传文件
        async function uploadFiles() {
            if (selectedFiles.length === 0) return;
            
            // 检查当前凭证总数
            const sessionId = getCookie('user_session');
            try {
                // 使用前端已有的凭证列表数据
                const credentialItems = document.querySelectorAll('#integratedCredentialsList .credential-item');
                const currentCredCount = credentialItems.length;
                
                // 检查总数限制
                if (currentCredCount + selectedFiles.length > 10) {
                    showStatus(`上传失败：凭证总数不能超过10个（当前${currentCredCount}个，选择${selectedFiles.length}个）`, 'error');
                    return;
                }
                
                // 继续上传流程
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });
                
                const response = await fetch('/user/credentials/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    showStatus('文件上传成功', 'success');
                    selectedFiles = [];
                    document.getElementById('uploadFileList').innerHTML = '';
                    document.getElementById('uploadBtn').disabled = true;
                    document.getElementById('fileInput').value = '';
                    refreshCredentials();
                } else {
                    const error = await response.json();
                    showStatus(error.detail || '上传失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误', 'error');
            }
        }
        // 切换凭证状态
        async function toggleCredential(filename, enable) {
            const sessionId = getCookie('user_session');
            try {
                const response = await fetch('/user/credentials/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ name: filename, action: enable ? 'enable' : 'disable' })
                });
                if (response.ok) {
                    showStatus(`凭证已${enable ? '启用' : '禁用'}`, 'success');
                    refreshCredentials();
                } else {
                    showStatus('操作失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误', 'error');
            }
        }
        // 删除凭证
        async function deleteCredential(filename) {
            if (!confirm(`确定要删除凭证文件 "${filename}" 吗？此操作不可恢复。`)) {
                return;
            }
            const sessionId = getCookie('user_session');
            try {
                const response = await fetch('/user/credentials/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ name: filename, action: 'delete' })
                });
                if (response.ok) {
                    showStatus('凭证已删除', 'success');
                    refreshCredentials();
                } else {
                    showStatus('删除失败', 'error');
                }
            } catch (error) {
                showStatus('网络错误', 'error');
            }
        }
        // 刷新凭证列表和使用统计
async function refreshCredentials() {
    document.getElementById('integratedCredentialsList').innerHTML = '<div class="loading">刷新中...</div>';
    await loadCredentials();
}
        // 切换标签
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }
        // 退出登录
        async function logout() {
            const sessionId = getCookie('user_session');
            try {
                await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    }
                });
            } catch (error) {
                console.error('退出登录请求失败:', error);
            }
            document.cookie = 'user_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            window.location.href = '/';
        }
        // 显示悬浮提示 (Toast) - 重写
        function showStatus(message, type = 'info') {
            const container = document.getElementById('toast-container');
            // 创建 toast 元素
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            // 添加到容器中
            container.appendChild(toast);
            // 动画结束后移除元素
            toast.addEventListener('animationend', () => {
                toast.remove();
            });
        }
        // hideStatus 函数不再需要
        // 获取Cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        // 使用统计相关函数
        let usageStatsData = {};
        let currentEditingFile = '';
        function openLimitsModal(filename, currentGeminiLimit, currentTotalLimit) {
            currentEditingFile = filename;
            document.getElementById('modalFilenameDisplay').textContent = filename;
            document.getElementById('modalGeminiLimit').value = currentGeminiLimit;
            document.getElementById('modalTotalLimit').value = currentTotalLimit;
            document.getElementById('limitsModal').style.display = 'block';
        }
        function closeLimitsModal() {
            document.getElementById('limitsModal').style.display = 'none';
            currentEditingFile = '';
        }
        async function saveLimits() {
            const geminiLimit = parseInt(document.getElementById('modalGeminiLimit').value);
            const totalLimit = parseInt(document.getElementById('modalTotalLimit').value);
            if (isNaN(geminiLimit) || geminiLimit < 0) {
                showStatus('Gemini 2.5 Pro 限制必须是大于等于0的数字', 'error');
                return;
            }
            if (isNaN(totalLimit) || totalLimit < 0) {
                showStatus('总调用限制必须是大于等于0的数字', 'error');
                return;
            }
            try {
                const sessionId = getCookie('user_session');
                const response = await fetch('/user/usage/update-limits', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: currentEditingFile,
                        gemini_2_5_pro_limit: geminiLimit,
                        total_limit: totalLimit
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showStatus(data.message, 'success');
                    closeLimitsModal();
                    setTimeout(() => refreshCredentials(), 500);
                } else {
                    showStatus(`设置失败: ${data.detail || data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('saveLimits error:', error);
                showStatus(`网络错误: ${error.message}`, 'error');
            }
        }
        window.onclick = function(event) {
            const modal = document.getElementById('limitsModal');
            if (event.target == modal) {
                closeLimitsModal();
            }
        }
    </script>
</body>
</html>
